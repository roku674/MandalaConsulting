# Copyright Header Check
# This workflow ensures all source files have proper copyright headers

name: Copyright Header Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, master, main]

jobs:
  copyright-check:
    runs-on: ubuntu-latest
    # Skip if:
    # 1. PR is from github-actions bot (prevent infinite loops)
    # 2. This is the Copyright/CopyrightAdder repo itself
    if: |
      github.actor != 'github-actions[bot]' && 
      github.actor != 'dependabot[bot]' &&
      github.repository != 'roku674/Copyright' &&
      github.repository != 'roku674/CopyrightAdder'
    permissions:
      contents: write
      pull-requests: write
      actions: write
      workflows: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Copyright Adder
        run: |
          # Create CopyrightAdder directory
          mkdir -p CopyrightAdder
          
          # Download the copyright script and sources file
          curl -sSL https://raw.githubusercontent.com/roku674/Copyright/main/CopyrightAdder/add_copyright_headers.sh -o CopyrightAdder/add_copyright_headers.sh
          curl -sSL https://raw.githubusercontent.com/roku674/Copyright/main/CopyrightAdder/sources.txt -o CopyrightAdder/sources.txt
          
          # Make script executable
          chmod +x CopyrightAdder/add_copyright_headers.sh
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*.{java,js,ts,jsx,tsx,cpp,cc,c,h,cs,py,go,rs,rb,php,sh,yaml,yml,json,xml,html,sql}
      
      - name: Run Copyright Adder on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "Adding copyright headers to changed files..."
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "Processing: $file"
              ./CopyrightAdder/add_copyright_headers.sh "$file"
            fi
          done
      
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Files missing copyright headers were found and updated."
            
            # List changed files for the PR description
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            git status --porcelain | grep -E "^\s*M" | cut -c 4-
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "All files have proper copyright headers."
          fi
      
      - name: Create new branch for copyright headers
        if: steps.check-changes.outputs.changes == 'true'
        id: create-branch
        run: |
          # Generate unique branch name
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          NEW_BRANCH="copyright-headers/${{ github.head_ref }}-${TIMESTAMP}"
          echo "branch_name=${NEW_BRANCH}" >> $GITHUB_OUTPUT
          
          # Create and checkout new branch
          git checkout -b "${NEW_BRANCH}"
          
          # Commit changes
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "Add copyright headers to source files"
          
          # Push the new branch
          git push origin "${NEW_BRANCH}"
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const baseBranch = '${{ github.head_ref }}';
            const changedFiles = `${{ steps.check-changes.outputs.changed_files }}`;
            
            const prBody = `## Copyright Headers Added
            
            This automated pull request adds missing copyright headers to source files in the \`${baseBranch}\` branch.
            
            ### Changed Files:
            \`\`\`
            ${changedFiles}
            \`\`\`
            
            ### Notes:
            - This PR was automatically generated by the Copyright Header Check workflow
            - Please review the changes before merging
            - This PR targets the source branch \`${baseBranch}\`, not the base branch
            
            ---
            *Generated by GitHub Actions*`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Add copyright headers to ${baseBranch}`,
              body: prBody,
              head: branchName,
              base: baseBranch,
              labels: ['copyright', 'automated']
            });
            
            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
            
            // Add comment to original PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ **Missing Copyright Headers Detected**\n\nI've created PR #${pr.data.number} to add missing copyright headers to your branch. Please review and merge it into your branch before this PR can be merged.`
            });
      
      - name: Clean up
        if: always()
        run: |
          rm -rf CopyrightAdder